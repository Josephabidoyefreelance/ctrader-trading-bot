<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Live Renko EMA Supertrend</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f6f6f6;
      }
      h2 {
        color: #222;
        text-align: center;
      }
      #chart {
        width: 100%;
        height: 700px;
      }
      #log {
        font-family: monospace;
        white-space: pre-wrap;
        padding: 10px;
        background: #fff;
        margin: 10px;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h2>ðŸ“Š Live Renko + EMA + Supertrend</h2>
    <div id="chart"></div>
    <div id="log"></div>

    <script>
      const ws = new WebSocket(`ws://${location.host}/ws`);
      let x = [],
        close = [],
        ema100 = [],
        ema300 = [],
        st = [],
        buy_x = [],
        buy_y = [],
        sell_x = [],
        sell_y = [];
      Plotly.newPlot("chart", [
        {
          x: x,
          y: close,
          type: "scatter",
          mode: "lines",
          name: "Renko",
          line: { color: "blue" },
        },
        {
          x: x,
          y: ema100,
          type: "scatter",
          mode: "lines",
          name: "EMA100",
          line: { color: "orange" },
        },
        {
          x: x,
          y: ema300,
          type: "scatter",
          mode: "lines",
          name: "EMA300",
          line: { color: "purple" },
        },
        {
          x: x,
          y: st,
          type: "scatter",
          mode: "lines",
          name: "Supertrend",
          line: { color: "green", dash: "dot" },
        },
        {
          x: buy_x,
          y: buy_y,
          mode: "markers",
          name: "BUY",
          marker: { color: "lime", size: 10, symbol: "triangle-up" },
        },
        {
          x: sell_x,
          y: sell_y,
          mode: "markers",
          name: "SELL",
          marker: { color: "red", size: 10, symbol: "triangle-down" },
        },
      ]);
      const log = document.getElementById("log");

      function logit(msg) {
        log.textContent = msg + "\n" + log.textContent;
      }

      ws.onmessage = (e) => {
        const m = JSON.parse(e.data);
        if (m.type !== "bar") return;
        const b = m.bar;
        const i = m.index;
        x.push(i);
        close.push(b.Close);
        ema100.push(b.EMA100);
        ema300.push(b.EMA300);
        st.push(b.ST);
        // buy/sell logic for markers
        if (i > 2) {
          const prevST = st[i - 2],
            prevClose = close[i - 2],
            prevEMA100 = ema100[i - 2],
            prevEMA300 = ema300[i - 2];
          if (prevST && prevClose) {
            const green =
              prevST < prevClose &&
              prevEMA100 > prevEMA300 &&
              b.Low < prevEMA300 &&
              b.Close > b.Open;
            const red =
              prevST > prevClose &&
              prevEMA100 < prevEMA300 &&
              b.High > prevEMA300 &&
              b.Close < b.Open;
            if (green) {
              buy_x.push(i);
              buy_y.push(b.Close);
              logit(`ðŸŸ¢ BUY @ ${b.Close.toFixed(5)}`);
            }
            if (red) {
              sell_x.push(i);
              sell_y.push(b.Close);
              logit(`ðŸ”´ SELL @ ${b.Close.toFixed(5)}`);
            }
          }
        }
        Plotly.update("chart", {
          x: [x, x, x, x, buy_x, sell_x],
          y: [close, ema100, ema300, st, buy_y, sell_y],
        });
      };
    </script>
  </body>
</html>
